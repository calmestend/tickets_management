<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tu Voz Importa - UTC</title>
	<style>
		:root {
			--primary-color: #17A67D;
			--secondary-color: #0D0D0D;
			--accent-color: #F2F2F2;
			--text-color: #333333;
			--highlight-color: #0FBBC9;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 0;
			background-color: var(--accent-color);
			color: var(--text-color);
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		header {
			background-color: var(--primary-color);
			color: white;
			padding: 20px 0;
			text-align: center;
			border-radius: 0 0 10px 10px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		h1 {
			margin: 0;
			font-size: 2.2rem;
		}

		.subtitle {
			font-style: italic;
			margin-top: 5px;
		}

		.nav-section {
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-wrap: wrap;
			gap: 10px;
			margin: 20px 0;
		}

		.login-btn {
			background-color: var(--highlight-color);
			color: white;
			padding: 10px 20px;
			border-radius: 25px;
			text-decoration: none;
			font-weight: bold;
			transition: all 0.3s ease;
			border: none;
			cursor: pointer;
		}

		.login-btn:hover {
			background-color: var(--primary-color);
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		}

		.login-btn.primary {
			background-color: var(--primary-color);
		}

		.login-btn.secondary {
			background-color: var(--secondary-color);
		}

		.login-btn.logout {
			background-color: #dc3545;
		}

		.login-btn.logout:hover {
			background-color: #c82333;
		}

		.main-flex {
			display: flex;
			gap: 30px;
		}

		.sidebar {
			background: white;
			padding: 25px 20px;
			border-radius: 12px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
			min-width: 220px;
			max-width: 300px;
			display: flex;
			flex-direction: column;
			height: fit-content;
		}

		.sidebar h3 {
			margin: 0 0 16px 0;
			font-size: 1.1rem;
			color: var(--primary-color);
			font-weight: 600;
		}

		.filter-list {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.filter-btn {
			background-color: var(--accent-color);
			border: 1px solid #ddd;
			padding: 10px 18px;
			border-radius: 20px;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: left;
			font-size: 1rem;
			font-weight: 500;
		}

		.filter-btn.active,
		.filter-btn:hover {
			background-color: var(--primary-color);
			color: white;
			border-color: var(--primary-color);
		}

		.stats-section {
			background-color: white;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 15px;
		}

		.stat-item {
			text-align: center;
			padding: 10px;
			background-color: var(--accent-color);
			border-radius: 8px;
		}

		.stat-number {
			font-size: 1.5rem;
			font-weight: bold;
			color: var(--primary-color);
		}

		.stat-label {
			font-size: 0.8rem;
			color: #666;
		}

		.ticket-container {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 20px;
			margin-top: 0;
		}

		.ticket-card {
			background-color: white;
			border-radius: 8px;
			padding: 20px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			transition: transform 0.3s ease;
		}

		.ticket-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
		}

		.ticket-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #eee;
		}

		.ticket-category {
			background-color: var(--primary-color);
			color: white;
			padding: 5px 10px;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: bold;
		}

		.ticket-date {
			color: #666;
			font-size: 0.9rem;
		}

		.ticket-title {
			font-weight: bold;
			margin-bottom: 10px;
			color: var(--secondary-color);
			font-size: 1.1rem;
		}

		.ticket-content {
			margin-bottom: 15px;
			line-height: 1.5;
		}

		.ticket-status {
			display: inline-block;
			padding: 3px 10px;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: bold;
		}

		.status-pendiente {
			background-color: #FFF3CD;
			color: #856404;
		}

		.status-en-proceso {
			background-color: #D1ECF1;
			color: #0C5460;
		}

		.status-resuelto {
			background-color: #D4EDDA;
			color: #155724;
		}

		.status-escalado {
			background-color: #F8D7DA;
			color: #721C24;
		}

		.no-tickets {
			text-align: center;
			padding: 40px;
			color: #666;
			font-style: italic;
			grid-column: 1 / -1;
		}

		.user-info {
			background-color: white;
			padding: 10px 15px;
			border-radius: 20px;
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 0.9rem;
		}

		.user-avatar {
			background-color: var(--primary-color);
			color: white;
			width: 30px;
			height: 30px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: bold;
			font-size: 0.8rem;
		}

		.ticket-user {
			font-size: 0.8rem;
			color: #666;
			margin-bottom: 5px;
		}

		.loading {
			text-align: center;
			padding: 40px;
			color: #666;
		}

		.error {
			text-align: center;
			padding: 40px;
			color: #dc3545;
			background-color: #f8d7da;
			border-radius: 8px;
			margin: 20px 0;
		}

		.ticket-img-evidence {
			display: block;
			margin: 8px 0;
			max-width: 80px;
			max-height: 80px;
			border-radius: 6px;
			border: 1px solid #eee;
		}

		.ticket-img-label {
			font-size: 0.8em;
			color: #666;
			display: block;
			margin-bottom: 4px;
		}

		@media (max-width: 1000px) {
			.main-flex {
				flex-direction: column;
			}

			.sidebar {
				max-width: 100%;
				min-width: unset;
				margin-bottom: 30px;
			}
		}
	</style>
</head>

<body>
	<header>
		<div class="container">
			<h1>¡Tu voz importa!</h1>
			<p class="subtitle">Comparte tus opiniones, quejas y sugerencias para mejorar nuestra universidad</p>
		</div>
	</header>

	<div class="container">
		<div class="nav-section" id="navigation">
			<!-- El contenido se cargará dinámicamente -->
		</div>
	</div>

	<div class="container main-flex">
		<aside class="sidebar">
			<h3>Filtrar por categoría</h3>
			<div class="filter-list">
				<button class="filter-btn active" data-filter="todos">Todos</button>
				<button class="filter-btn" data-filter="servicios-academicos">Servicios Académicos</button>
				<button class="filter-btn" data-filter="infraestructura">Infraestructura</button>
				<button class="filter-btn" data-filter="cafeteria">Cafetería</button>
				<button class="filter-btn" data-filter="biblioteca">Biblioteca</button>
				<button class="filter-btn" data-filter="tecnologia">Tecnología</button>
				<button class="filter-btn" data-filter="administrativo">Administrativo</button>
				<button class="filter-btn" data-filter="servicios-estudiantiles">Servicios Estudiantiles</button>
			</div>
			<div class="stats-section" id="statsSection" style="margin-top: 30px; display: none;">
				<h3>Estadísticas Generales</h3>
				<div class="stats-grid" id="statsGrid"></div>
			</div>
		</aside>

		<main style="flex:1;">
			<div class="ticket-container" id="ticketsContainer">
				<div class="loading">
					<p>Cargando tickets...</p>
				</div>
			</div>
		</main>
	</div>

	<script>
		let allTickets = [];
		let currentFilter = 'todos';

		document.addEventListener('DOMContentLoaded', function () {
			checkSession();
			loadTickets();
			loadStats();
		});

		async function checkSession() {
			try {
				const response = await fetch('/check-session');
				const data = await response.json();

				const navigation = document.getElementById('navigation');

				if (data.authenticated) {
					navigation.innerHTML = `
		<div class="user-info">
			<div class="user-avatar">
				${data.user.name[0]}${data.user.name.split(' ')[1] ? data.user.name.split(' ')[1][0] : ''}
			</div>
			<span>Hola, ${data.user.name}</span>
		</div>
		<div style="display: flex; gap: 10px; flex-wrap: wrap;">
			${data.user.role === 'admin' ? '<a href="/ticket" class="login-btn primary">Validar Tickets</a>' : '<a href="/post" class="login-btn primary">Nueva queja/sugerencia</a>'}
			${data.user.role === 'admin' ? '' : '<a href="/profile" class="login-btn">Mi Perfil</a>'}
			<a href="/logout" class="login-btn logout">Cerrar Sesión</a>
		</div>
	`;
				} else {
					navigation.innerHTML = `
		<div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%; justify-content: center;">
			<a href="/auth" class="login-btn primary">Iniciar Sesión</a>
		</div>
	`;
				}

			} catch (error) {
				console.error('Error checking session:', error);
				const navigation = document.getElementById('navigation');
				navigation.innerHTML = `
					<div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%; justify-content: center;">
						<a href="/auth" class="login-btn primary">Iniciar Sesión</a>
					</div>
				`;
			}
		}

		async function loadTickets() {
			const container = document.getElementById('ticketsContainer');

			try {
				container.innerHTML = '<div class="loading"><p>Cargando tickets...</p></div>';

				const response = await fetch('/api/tickets');
				const data = await response.json();

				if (data.success) {
					allTickets = data.tickets;
					displayTickets(allTickets);
				} else {
					throw new Error(data.error || 'Error desconocido');
				}
			} catch (error) {
				console.error('Error loading tickets:', error);
				container.innerHTML = `
					<div class="error">
						<p>❌ Error al cargar los tickets: ${error.message}</p>
						<button onclick="loadTickets()" class="login-btn" style="margin-top: 10px;">Reintentar</button>
					</div>
				`;
			}
		}

		async function loadStats() {
			try {
				const response = await fetch('/api/tickets/stats');
				const data = await response.json();

				if (data.success) {
					displayStats(data.stats);
				}
			} catch (error) {
				console.error('Error loading stats:', error);
			}
		}

		function displayStats(stats) {
			const statsSection = document.getElementById('statsSection');
			const statsGrid = document.getElementById('statsGrid');

			statsGrid.innerHTML = `
				<div class="stat-item">
					<div class="stat-number">${stats.total_tickets}</div>
					<div class="stat-label">Total de Tickets</div>
				</div>
				<div class="stat-item">
					<div class="stat-number">${stats.by_status.pendiente || 0}</div>
					<div class="stat-label">Pendientes</div>
				</div>
				<div class="stat-item">
					<div class="stat-number">${stats.by_status['en-proceso'] || 0}</div>
					<div class="stat-label">En Proceso</div>
				</div>
				<div class="stat-item">
					<div class="stat-number">${stats.by_status.resuelto || 0}</div>
					<div class="stat-label">Resueltos</div>
				</div>
			`;

			statsSection.style.display = 'block';
		}

		function displayTickets(tickets) {
			const container = document.getElementById('ticketsContainer');
			if (tickets.length === 0) {
				container.innerHTML = `
					<div class="no-tickets">
						<p>No hay tickets para mostrar${currentFilter !== 'todos' ? ' en esta categoría' : ''}.</p>
					</div>
				`;
				return;
			}
			container.innerHTML = tickets.map(ticket => {
				let userImageHtml = '';
				let adminImageHtml = '';
				// Imagen subida por el usuario (si existe)
				if (ticket.user_image && ticket.user_image !== '') {
					userImageHtml = `
						<img src="/static/${ticket.user_image}" alt="Evidencia usuario" class="ticket-img-evidence">
						<span class="ticket-img-label">Evidencia usuario</span>
					`;
				}
				// Imagen subida por el admin (comprobante resolución)
				if (ticket.admin_image && ticket.admin_image !== '') {
					adminImageHtml = `
						<img src="/static/${ticket.admin_image}" alt="Comprobante resolución" class="ticket-img-evidence">
						<span class="ticket-img-label">Comprobante resolución</span>
					`;
				}
				return `
				<div class="ticket-card">
					<div class="ticket-header">
						<span class="ticket-category">${ticket.categoryName}</span>
						<span class="ticket-date">${formatDate(ticket.date)}</span>
					</div>
					<div class="ticket-user">Por: ${ticket.user.name} ${ticket.user.last_name}</div>
					${userImageHtml}
					<h3 class="ticket-title">
						${ticket.title}
					</h3>
					<p class="ticket-content">${ticket.content}</p>
					${ticket.incident_date ? `<p class="ticket-date"><strong>Fecha del incidente:</strong> ${formatDate(ticket.incident_date)}</p>` : ''}
					<span class="ticket-status status-${ticket.status}">${getStatusText(ticket.status)}</span>
					${adminImageHtml}
				</div>
				`;
			}).join('');
		}

		async function filterTickets(category) {
			currentFilter = category;
			const container = document.getElementById('ticketsContainer');

			try {
				container.innerHTML = '<div class="loading"><p>Filtrando tickets...</p></div>';

				let url = '/api/tickets';
				if (category !== 'todos') {
					url = `/api/tickets/filter/${category}`;
				}

				const response = await fetch(url);
				const data = await response.json();

				if (data.success) {
					displayTickets(data.tickets);
				} else {
					throw new Error(data.error || 'Error al filtrar');
				}
			} catch (error) {
				console.error('Error filtering tickets:', error);
				container.innerHTML = `
					<div class="error">
						<p>❌ Error al filtrar tickets: ${error.message}</p>
						<button onclick="filterTickets('${category}')" class="login-btn" style="margin-top: 10px;">Reintentar</button>
					</div>
				`;
			}
		}

		function formatDate(dateString) {
			const date = new Date(dateString + 'T00:00:00');
			return date.toLocaleDateString('es-ES', {
				day: '2-digit',
				month: '2-digit',
				year: 'numeric'
			});
		}

		function getStatusText(status) {
			const statusMap = {
				'pendiente': 'Pendiente',
				'en-proceso': 'En progreso',
				'resuelto': 'Resuelto',
				'escalado': 'Escalado'
			};
			return statusMap[status] || status;
		}


		document.querySelectorAll('.filter-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
				btn.classList.add('active');

				const filter = btn.getAttribute('data-filter');
				filterTickets(filter);
			});
		});
	</script>
</body>

</html>
