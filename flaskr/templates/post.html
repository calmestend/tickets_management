<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Nueva Queja o Sugerencia - UTC</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #f0f9ff 0%, #c6f6d5 100%);
			min-height: 100vh;
			color: #1a202c;
			padding: 20px;
		}

		.header {
			background: white;
			padding: 15px 30px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.nav-links {
			display: flex;
			gap: 15px;
		}

		.nav-links a {
			color: #38a169;
			text-decoration: none;
			font-weight: 500;
			padding: 8px 15px;
			border-radius: 8px;
			transition: all 0.3s ease;
		}

		.nav-links a:hover {
			background-color: #38a169;
			color: white;
		}

		.container {
			max-width: 700px;
			margin: 0 auto;
			background: white;
			border-radius: 15px;
			box-shadow: 0 6px 30px rgba(0, 0, 0, 0.1);
			overflow: hidden;
		}

		.form-header {
			background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
			color: white;
			padding: 30px;
			text-align: center;
		}

		.form-header h1 {
			font-size: 28px;
			margin-bottom: 10px;
			font-weight: 300;
		}

		.form-header p {
			opacity: 0.9;
			font-size: 16px;
		}

		.form-content {
			padding: 40px;
		}

		.form-section {
			margin-bottom: 30px;
			padding: 25px;
			border: 1px solid #e2e8f0;
			border-radius: 12px;
			background: #f7fafc;
		}

		.section-title {
			color: #2d3748;
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 20px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		label {
			display: block;
			margin-bottom: 8px;
			color: #2d3748;
			font-weight: 600;
			font-size: 14px;
		}

		.required {
			color: #e53e3e;
		}

		input[type="text"],
		input[type="email"],
		input[type="date"],
		select,
		textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			font-size: 14px;
			font-family: inherit;
			transition: all 0.3s ease;
			background: white;
		}

		input:focus,
		select:focus,
		textarea:focus {
			outline: none;
			border-color: #38a169;
			box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.1);
		}

		textarea {
			resize: vertical;
			min-height: 120px;
			line-height: 1.5;
		}

		.description-area {
			background: #f0fff4;
			border: 2px solid #38a169;
			min-height: 150px;
		}

		.category-select {
			background: #f0fff4;
			border: 2px solid #38a169;
		}

		.char-counter {
			text-align: right;
			font-size: 12px;
			color: #718096;
			margin-top: 5px;
		}

		/* Estilos para subida de archivos */
		.file-upload-area {
			border: 2px dashed #38a169;
			border-radius: 12px;
			padding: 30px;
			text-align: center;
			background: #f0fff4;
			transition: all 0.3s ease;
			cursor: pointer;
			position: relative;
		}

		.file-upload-area:hover {
			border-color: #2d7d50;
			background: #e6fffa;
		}

		.file-upload-area.dragover {
			border-color: #2d7d50;
			background: #e6fffa;
			transform: scale(1.02);
		}

		.file-input {
			display: none;
		}

		.file-upload-icon {
			font-size: 48px;
			color: #38a169;
			margin-bottom: 15px;
		}

		.file-upload-text {
			color: #2d3748;
			font-size: 16px;
			font-weight: 600;
			margin-bottom: 8px;
		}

		.file-upload-hint {
			color: #718096;
			font-size: 14px;
			margin-bottom: 15px;
		}

		.file-restrictions {
			color: #4a5568;
			font-size: 12px;
			margin-top: 10px;
			padding: 10px;
			background: #edf2f7;
			border-radius: 6px;
		}

		.uploaded-files {
			margin-top: 20px;
		}

		.file-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 12px 15px;
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 8px;
			margin-bottom: 10px;
		}

		.file-info {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.file-icon {
			font-size: 20px;
			color: #38a169;
		}

		.file-details {
			display: flex;
			flex-direction: column;
		}

		.file-name {
			font-weight: 600;
			color: #2d3748;
			font-size: 14px;
		}

		.file-size {
			color: #718096;
			font-size: 12px;
		}

		.remove-file {
			background: #e53e3e;
			color: white;
			border: none;
			border-radius: 50%;
			width: 24px;
			height: 24px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 14px;
			transition: all 0.3s ease;
		}

		.remove-file:hover {
			background: #c53030;
			transform: scale(1.1);
		}

		.action-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			margin-top: 30px;
			flex-wrap: wrap;
		}

		.btn {
			padding: 15px 30px;
			border: none;
			border-radius: 25px;
			cursor: pointer;
			font-size: 16px;
			font-weight: 600;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			gap: 10px;
			min-width: 160px;
			justify-content: center;
		}

		.btn-primary {
			background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
			color: white;
		}

		.btn-primary:hover:not(:disabled) {
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
		}

		.btn-primary:disabled {
			background: #cbd5e0;
			cursor: not-allowed;
			transform: none;
		}

		.btn-secondary {
			background: #e2e8f0;
			color: #4a5568;
		}

		.btn-secondary:hover {
			background: #cbd5e0;
			transform: translateY(-2px);
		}

		.notification {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 15px 25px;
			border-radius: 8px;
			color: white;
			font-weight: 500;
			z-index: 1000;
			transform: translateX(400px);
			transition: transform 0.3s ease;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			max-width: 350px;
		}

		.notification.show {
			transform: translateX(0);
		}

		.notification.success {
			background: #38a169;
		}

		.notification.error {
			background: #e53e3e;
		}

		.notification.info {
			background: #3182ce;
		}

		.help-text {
			font-size: 12px;
			color: #718096;
			margin-top: 5px;
			font-style: italic;
		}

		.readonly-field {
			background: #f7fafc !important;
			cursor: not-allowed !important;
			color: #4a5568;
		}

		@media (max-width: 768px) {
			.form-row {
				grid-template-columns: 1fr;
			}

			.action-buttons {
				flex-direction: column;
				align-items: center;
			}

			.btn {
				width: 100%;
				max-width: 300px;
			}

			.form-content {
				padding: 20px;
			}

			.header {
				flex-direction: column;
				gap: 15px;
				text-align: center;
			}

			.file-upload-area {
				padding: 20px;
			}

			.file-upload-icon {
				font-size: 36px;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="form-header">
			<h1>Nueva Queja o Sugerencia</h1>
			<p>Tu opini√≥n es importante para mejorar nuestra universidad</p>
		</div>

		<div class="form-content">
			<form id="complaintForm">
				<!-- Informaci√≥n Personal -->
				<div class="form-section">
					<h3 class="section-title">
						üë§ Informaci√≥n Personal
					</h3>

					<div class="form-row">
						<div class="form-group">
							<label for="studentName">Nombre Completo <span class="required">*</span></label>
							<input type="text" id="studentName" value="Juan P√©rez Garc√≠a" readonly class="readonly-field">
						</div>
						<div class="form-group">
							<label for="studentEmail">Email Institucional <span class="required">*</span></label>
							<input type="email" id="studentEmail" value="juan.perez@utc.edu.mx" readonly class="readonly-field">
						</div>
					</div>

					<div class="form-row">
						<div class="form-group">
							<label for="carrera">Carrera</label>
							<input type="text" id="carrera" value="Ingenier√≠a en Sistemas" readonly class="readonly-field">
						</div>
						<div class="form-group">
							<label for="semestre">Semestre</label>
							<input type="text" id="semestre" value="5¬∫ Semestre" readonly class="readonly-field">
						</div>
					</div>
				</div>

				<!-- Detalles de la Queja/Sugerencia -->
				<div class="form-section">
					<h3 class="section-title">
						üìã Detalles de tu Solicitud
					</h3>

					<div class="form-row">
						<div class="form-group">
							<label for="complaint_type">Tipo de Solicitud <span class="required">*</span></label>
							<select id="complaint_type" name="complaint_type" class="category-select" required>
								<option value="">Seleccionar tipo...</option>
								<option value="queja">üî¥ Queja</option>
								<option value="sugerencia">üí° Sugerencia</option>
								<option value="peticion">üìû Petici√≥n</option>
							</select>
						</div>
						<div class="form-group">
							<label for="category">Categor√≠a <span class="required">*</span></label>
							<select id="category" name="category" class="category-select" required>
								<option value="">Seleccionar categor√≠a...</option>
								<option value="servicios-academicos">üìö Servicios Acad√©micos</option>
								<option value="infraestructura">üè¢ Infraestructura</option>
								<option value="servicios-estudiantiles">üéì Servicios Estudiantiles</option>
								<option value="tecnologia">üíª Tecnolog√≠a</option>
								<option value="administrativo">üìÑ Administrativo</option>
								<option value="biblioteca">üìñ Biblioteca</option>
								<option value="cafeteria">üçΩÔ∏è Cafeter√≠a</option>
								<option value="otro">üîß Otro</option>
							</select>
						</div>
					</div>

					<div class="form-row">
						<div class="form-group">
							<label for="subject">Asunto <span class="required">*</span></label>
							<input type="text" id="subject" name="subject" placeholder="Resumen breve de tu solicitud" maxlength="100"
								required>
							<div class="char-counter">
								<span id="subjectCounter">0</span>/100 caracteres
							</div>
						</div>
						<div class="form-group">
							<label for="incident_date">Fecha del Incidente</label>
							<input type="date" id="incident_date" name="incident_date">
							<div class="help-text">Fecha en que ocurri√≥ el problema</div>
						</div>
					</div>

					<div class="form-group">
						<label for="description">Descripci√≥n Detallada <span class="required">*</span></label>
						<textarea id="description" name="description" class="description-area"
							placeholder="Describe detalladamente tu queja, sugerencia o petici√≥n. Incluye todos los detalles relevantes..."
							maxlength="1000" required></textarea>
						<div class="char-counter">
							<span id="descriptionCounter">0</span>/1000 caracteres
						</div>
						<div class="help-text">S√© espec√≠fico: ¬øqu√© pas√≥?, ¬øcu√°ndo?, ¬ød√≥nde?, ¬øqui√©n estuvo involucrado?</div>
					</div>
				</div>

				<!-- Secci√≥n de archivos adjuntos -->
				<div class="form-section">
					<h3 class="section-title">
						üìé Archivos Adjuntos
					</h3>

					<div class="form-group">
						<label>Adjuntar Evidencia</label>
						<div class="file-upload-area" id="fileUploadArea">
							<div class="file-upload-icon">üìÅ</div>
							<div class="file-upload-text">Arrastra archivos aqu√≠ o haz clic para seleccionar</div>
							<div class="file-upload-hint">Puedes adjuntar capturas de pantalla, documentos o cualquier evidencia que
								respalde tu solicitud</div>
							<input type="file" id="fileInput" class="file-input" multiple
								accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt">
						</div>
						<div class="file-restrictions">
							<strong>Restricciones:</strong> M√°ximo 5 archivos, 10MB por archivo.
							Formatos permitidos: PDF, DOC, DOCX, JPG, JPEG, PNG, GIF, TXT
						</div>
					</div>

					<div class="uploaded-files" id="uploadedFiles" style="display: none;">
						<h4 style="margin-bottom: 15px; color: #2d3748;">Archivos seleccionados:</h4>
						<div id="filesList"></div>
					</div>
				</div>

				<div class="action-buttons">
					<button type="button" class="btn btn-secondary" onclick="window.history.back()">
						‚Ü™Ô∏è Cancelar
					</button>
					<button type="submit" class="btn btn-primary" id="submitBtn">
						üì§ Enviar Solicitud
					</button>
				</div>
			</form>
		</div>
	</div>

	<div id="notification" class="notification"></div>

	<script>
		// Variables globales para manejo de archivos
		let selectedFiles = [];
		const maxFiles = 5;
		const maxFileSize = 10 * 1024 * 1024; // 10MB en bytes
		// Tipos de archivo permitidos (MIME types)
		const allowedTypes = [
			'image/jpeg',
			'image/jpg',
			'image/png',
			'image/gif',
			'application/pdf',
			'application/msword',
			'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
			'text/plain'
		];

		// Extensiones permitidas (como respaldo)
		const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'txt'];

		// Contadores de caracteres
		function setupCharCounters() {
			const fields = [
				{input: 'subject', counter: 'subjectCounter', max: 100},
				{input: 'description', counter: 'descriptionCounter', max: 1000}
			];

			fields.forEach(field => {
				const input = document.getElementById(field.input);
				const counter = document.getElementById(field.counter);

				if (input && counter) {
					input.addEventListener('input', function () {
						const count = this.value.length;
						counter.textContent = count;

						if (count > field.max * 0.9) {
							counter.style.color = '#e53e3e';
						} else {
							counter.style.color = '#718096';
						}
					});
				}
			});
		}

		// Funci√≥n para mostrar notificaciones
		function showNotification(message, type = 'success') {
			const notification = document.getElementById('notification');
			notification.textContent = message;
			notification.className = `notification ${type} show`;

			setTimeout(() => {
				notification.classList.remove('show');
			}, 5000);
		}

		// Funci√≥n para formatear el tama√±o de archivo
		function formatFileSize(bytes) {
			if (bytes === 0) return '0 Bytes';
			const k = 1024;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
		}

		// Funci√≥n para validar archivos
		function validateFile(file) {
			console.log(`Validando archivo: ${file.name}, tipo: ${file.type}, tama√±o: ${file.size}`);

			// Obtener extensi√≥n del archivo
			const fileExtension = file.name.split('.').pop().toLowerCase();

			// Validar por tipo MIME y extensi√≥n (doble validaci√≥n)
			const isValidType = allowedTypes.includes(file.type);
			const isValidExtension = allowedExtensions.includes(fileExtension);

			if (!isValidType && !isValidExtension) {
				return `Tipo de archivo no permitido: ${file.name}. Formatos permitidos: JPG, JPEG, PNG, GIF, PDF, DOC, DOCX, TXT`;
			}

			if (file.size === 0) {
				return `Archivo vac√≠o: ${file.name}`;
			}

			if (file.size > maxFileSize) {
				return `Archivo muy grande: ${file.name} (${formatFileSize(file.size)}). M√°ximo 10MB.`;
			}

			return null;
		}

		// Funci√≥n para agregar archivos
		function addFiles(files) {
			const fileArray = Array.from(files);
			console.log(`Intentando agregar ${fileArray.length} archivos`);

			if (selectedFiles.length + fileArray.length > maxFiles) {
				showNotification(`M√°ximo ${maxFiles} archivos permitidos`, 'error');
				return;
			}

			let addedCount = 0;
			for (let file of fileArray) {
				const error = validateFile(file);
				if (error) {
					showNotification(error, 'error');
					continue;
				}

				// Verificar si el archivo ya existe
				if (selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
					showNotification(`El archivo ${file.name} ya est√° seleccionado`, 'error');
					continue;
				}

				selectedFiles.push(file);
				addedCount++;
				console.log(`Archivo agregado: ${file.name}`);
			}

			if (addedCount > 0) {
				showNotification(`${addedCount} archivo(s) agregado(s) correctamente`, 'success');
				updateFilesList();
			}
		}

		// Funci√≥n para actualizar la lista de archivos
		function updateFilesList() {
			const uploadedFilesDiv = document.getElementById('uploadedFiles');
			const filesListDiv = document.getElementById('filesList');

			if (selectedFiles.length === 0) {
				uploadedFilesDiv.style.display = 'none';
				return;
			}

			uploadedFilesDiv.style.display = 'block';
			filesListDiv.innerHTML = '';

			selectedFiles.forEach((file, index) => {
				const fileItem = document.createElement('div');
				fileItem.className = 'file-item';

				const fileExtension = file.name.split('.').pop().toLowerCase();
				let fileIcon = 'üìÑ';

				if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
					fileIcon = 'üñºÔ∏è';
				} else if (fileExtension === 'pdf') {
					fileIcon = 'üìï';
				} else if (['doc', 'docx'].includes(fileExtension)) {
					fileIcon = 'üìù';
				} else if (fileExtension === 'txt') {
					fileIcon = 'üìù';
				}

				fileItem.innerHTML = `
					<div class="file-info">
						<div class="file-icon">${fileIcon}</div>
						<div class="file-details">
							<div class="file-name">${file.name}</div>
							<div class="file-size">${formatFileSize(file.size)}</div>
						</div>
					</div>
					<button type="button" class="remove-file" onclick="removeFile(${index})">√ó</button>
				`;

				filesListDiv.appendChild(fileItem);
			});
		}

		// Funci√≥n para remover archivo
		function removeFile(index) {
			const removedFile = selectedFiles[index];
			selectedFiles.splice(index, 1);
			showNotification(`Archivo ${removedFile.name} eliminado`, 'info');
			updateFilesList();
		}

		// Configurar drag and drop
		function setupFileUpload() {
			const fileUploadArea = document.getElementById('fileUploadArea');
			const fileInput = document.getElementById('fileInput');

			// Click para seleccionar archivos
			fileUploadArea.addEventListener('click', () => {
				console.log('√Årea de upload clickeada, abriendo selector de archivos...');
				fileInput.click();
			});

			// Cambio en input file
			fileInput.addEventListener('change', (e) => {
				const files = e.target.files;
				console.log(`Archivos seleccionados desde input: ${files.length}`);
				if (files.length > 0) {
					addFiles(files);
				}
				e.target.value = ''; // Limpiar input para permitir seleccionar el mismo archivo
			});

			// Drag and drop events
			['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
				fileUploadArea.addEventListener(eventName, preventDefaults, false);
				document.body.addEventListener(eventName, preventDefaults, false);
			});

			function preventDefaults(e) {
				e.preventDefault();
				e.stopPropagation();
			}

			['dragenter', 'dragover'].forEach(eventName => {
				fileUploadArea.addEventListener(eventName, () => {
					fileUploadArea.classList.add('dragover');
				});
			});

			['dragleave', 'drop'].forEach(eventName => {
				fileUploadArea.addEventListener(eventName, () => {
					fileUploadArea.classList.remove('dragover');
				});
			});

			fileUploadArea.addEventListener('drop', (e) => {
				const dt = e.dataTransfer;
				const files = dt.files;
				console.log(`Archivos desde drag & drop: ${files.length}`);
				if (files.length > 0) {
					addFiles(files);
				}
			});
		}

		// Manejar env√≠o del formulario
		document.getElementById('complaintForm').addEventListener('submit', async function (e) {
			e.preventDefault();

			const submitBtn = document.getElementById('submitBtn');

			// Deshabilitar bot√≥n
			submitBtn.disabled = true;
			submitBtn.innerHTML = '‚è≥ Enviando...';

			// Crear FormData para enviar archivos tambi√©n
			const formData = new FormData(this);

			// Agregar archivos al FormData
			selectedFiles.forEach((file, index) => {
				formData.append(`files`, file);
				console.log(`Agregando archivo al FormData: ${file.name}`);
			});

			// Validar campos requeridos
			const requiredFields = ['complaint_type', 'category', 'subject', 'description'];
			let isValid = true;

			requiredFields.forEach(fieldName => {
				const field = document.getElementById(fieldName);
				const value = formData.get(fieldName);
				if (!value || !value.toString().trim()) {
					field.style.borderColor = '#e53e3e';
					isValid = false;
				} else {
					field.style.borderColor = '#e2e8f0';
				}
			});

			if (!isValid) {
				showNotification('Por favor completa todos los campos requeridos', 'error');
				submitBtn.disabled = false;
				submitBtn.innerHTML = 'üì§ Enviar Solicitud';
				return;
			}

			try {
				console.log('Enviando formulario...');
				console.log(`Archivos a enviar: ${selectedFiles.length}`);

				const response = await fetch('/post', {
					method: 'POST',
					body: formData
				});

				const result = await response.json();
				console.log('Respuesta del servidor:', result);

				if (result.success) {
					showNotification(result.message, 'success');

					// Limpiar formulario despu√©s de un delay
					setTimeout(() => {
						this.reset();
						selectedFiles = [];
						updateFilesList();
						setupCharCounters();
						// Opcional: redirigir
						// window.location.href = '/';
					}, 2000);
				} else {
					showNotification(result.message, 'error');
					if (result.errors) {
						result.errors.forEach(error => {
							console.error('Error de validaci√≥n:', error);
						});
					}
				}
			} catch (error) {
				console.error('Error:', error);
				showNotification('Error de conexi√≥n. Int√©ntalo de nuevo.', 'error');
			}

			// Habilitar bot√≥n nuevamente
			submitBtn.disabled = false;
			submitBtn.innerHTML = 'üì§ Enviar Solicitud';
		});

		// Inicializar componentes al cargar la p√°gina
		document.addEventListener('DOMContentLoaded', function () {
			console.log('Inicializando formulario...');
			setupCharCounters();
			setupFileUpload();
		});
	</script>
</body>

</html>
